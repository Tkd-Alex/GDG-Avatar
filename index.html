<!doctype html>
<html lang="it">

<head>
  <meta charset="utf-8">
  <title>GDG Support</title>
  
  <!-- javascript -->
  <script src="js/jquery.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/ripples.min.js"></script>
  <script src="js/material.min.js"></script>

  <!-- style -->
  <link rel="stylesheet" href="css/bootstrap.min.css"/>
  <link rel="stylesheet" href="css/bootstrap-material-design.min.css"/>
  <link rel="stylesheet" href="css/ripples.min.css"/>

  <!-- font -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

</head>

<body>
  <div class="container-fluid">
    
  <div class="col-xs-6">

    <h3>Your image</h3>

    <div id="myImage"></div>
    <canvas id="canvas" width=300 height=300 hidden="true"></canvas>

  </div>
      
  <div class="col-xs-6">    

    <form class="form-horizontal">
          
      <div class="form-group label-floating">
        <label for="i5" class="control-label">Nome GDG</label>
        <input type="text" class="form-control" id="gdgName">
      </div>

      <div class="form-group">
        <input type="file" id='uploadimage' accept="image/*;capture=camera">

        <div class="input-group">
          <input type="text" readonly="" class="form-control" placeholder="Please select a file...">
          <span class="input-group-btn input-group-sm">
            <button type="button" class="btn btn-fab btn-fab-mini">
              <i class="material-icons">attach_file</i>
            </button>
          </span>
        </div>
      </div>

      <div class="togglebutton">
        <label> BlackWhite  
          <input type="checkbox" checked="" id="colorSet"></span> 
        </label>
      </div>
    
      
      <div class="togglebutton">
        <label> WTM
          <input type="checkbox" checked="" id="wtm"></span> 
        </label>
      </div>

      <div class="togglebutton">
        <label> SquareCrop
          <input type="checkbox" checked="" id="squareCrop"></span> 
        </label>
      </div>

      <a href="javascript:void(0)" id="download" class="btn btn-raised btn-success">Download as .png<div class="ripple-container"></div></a>
    
    </form>

  </div>

</div>

  <script>

  $.material.init();

  function downloadCanvas(link, canvasId, filename) {
    link.href = document.getElementById(canvasId).toDataURL();
    link.download = filename;
  }

  document.getElementById('download').addEventListener('click', function() {
    downloadCanvas(this, 'myCanvasDownload', 'image.png');
  }, false);
        
  document.getElementById("uploadimage").addEventListener("change", draw, false);

  var logo = new Image();
  logo.crossOrigin='anonymous';

  var logoWtm = new Image();
  logoWtm.crossOrigin='anonymous';
  logoWtm.src = "img/wtm.png";
  logoWtm.onload = function() { console.log("Caricato");}

  function draw(ev) {
    console.log(ev);
    var ctx = document.getElementById('canvas').getContext('2d'),
        img = new Image(),
        f = document.getElementById("uploadimage").files[0],
        url = window.URL || window.webkitURL,
        src = url.createObjectURL(f);

    img.src = src;
    img.onload = function() {

        if(document.getElementById("squareCrop").checked){
      
          canvas.width=500;
          canvas.height=500;

          ctx.drawImage(img, 0, 0, 500, 500);
        }else if(img.width > 500){
          canvas.width=500;
          canvas.height=img.height / img.width * 500;
          ctx.drawImage(img,0,0,500,img.height / img.width * 500);
        }else{
          canvas.width=img.width;
          canvas.height=img.height;
          ctx.drawImage(img,0,0);
        }


        

        if(document.getElementById("colorSet").checked){
        
                var imageData = ctx.getImageData(0, 0, img.width, img.height);
                var data = imageData.data;
        
                for(var i = 0; i < data.length; i += 4) {
                  var brightness = 0.34 * data[i] + 0.5 * data[i + 1] + 0.16 * data[i + 2];
                  // red
                  data[i] = brightness;
                  // green
                  data[i + 1] = brightness;
                  // blue
                  data[i + 2] = brightness;
                }
        
                // overwrite original image
                ctx.putImageData(imageData, 0, 0);}

        logo.src = "img/logo.png";
        logo.onload = start;
        url.revokeObjectURL(src);
    }
}

  function start(){
    applyText(canvas,document.getElementById('gdgName').value);
  }

  function applyText(canvas,text){
    var tempCanvas = document.createElement('canvas');
    var tempCtx = tempCanvas.getContext('2d');
    var cw,ch;
    
    cw = tempCanvas.width = canvas.width;
    ch = tempCanvas.height = canvas.height;
    
    tempCtx.drawImage(canvas,0,0);
    tempCtx.font = "30px verdana";
    
    var textWidth = tempCtx.measureText(text).width;
    
    tempCtx.fillStyle = 'white';
    tempCtx.fillText(text,cw-textWidth-10, 30);

    var new_height = logo.height / logo.width * cw; 

    tempCtx.drawImage(logo,0,ch-new_height,cw,new_height);

    if(document.getElementById("wtm").checked){
      var widthWMT = 100;
      var new_height = logoWtm.height / logoWtm.width * widthWMT; 
      tempCtx.drawImage(logoWtm,0,0,widthWMT,new_height);
    }

    if(document.getElementById('myCanvasDownload'))
      document.getElementById('myImage').removeChild(document.getElementById('myCanvasDownload'));  
    
    tempCanvas.setAttribute('id','myCanvasDownload');
    document.getElementById('myImage').appendChild(tempCanvas);


  }

  </script>

</body>

</html>
